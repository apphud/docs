# События

В этом разделе описаны события, которые регистрируются в Apphud и могут отсылаться в сторонние системы аналитики.

В определенные моменты времени Apphud запрашивает с серверов Apple информацию о текущем состоянии авто-возобновляемой подписки каждого клиента. Если необходимо, регистрирует соответствующее событие и отсылает его во внешнюю аналитику или мессенджер.

## Триальный период

### Оформление триала

Это событие создается, когда пользователь впервые начинает триальный период подписки.

> Каждый пользователь с уникальным Apple ID может воспользоваться триалом только один раз в рамках одной группы подписок.

> В сторонние системы аналитики это событие отсылается под названием *trial_started*.

### Успешная конвертация триала в обычную подписку

Это событие создается по окончании триала, если пользователь оплачивает первый цикл обычной подписки. 

> В сторонние системы аналитики это событие отсылается под названием *trial_converted*.

### Неудачная конвертация триала в обычную подписку

Это событие создается *по окончании* триала, если ее не удалось ее продлить.

> В сторонние системы аналитики это событие отсылается под названием *trial_expired*.

Продление может не произойти по этим причинам:

* пользователь сам отменил подписку через приложение "Настройки" или "App Store" – *user_canceled*;
* произошла ошибка при списании денег пользователя при попытке продления подписки – *billing_issue*;
* пользователь не согласился с повышением цены на подписку – *declined_price_increase*;
* продукт (подписка) была недоступна при попытке продления – *unavailable_product*;
* произошла неизвестная ошибка при попытке продления подписки – *unknown_error*.

## Обычная подписка

Рассмотрим события, которые создаются в рамках подписки.

### Успешное оформление подписки

Это событие создается, когда пользователь оформляет обычную подписку. За нее в этот момент с него списываются деньги.

> В сторонние системы аналитики это событие отсылается под названием *subscription_started*.

> Если пользователь оформляет вводное предложение – Introductory offer, то событие отсылается с флагом `in_intro = TRUE`.

> Вводное предложение – это специальное предложение, которое действует только для новых подписчиков. Более подробно о разновидностях вводных предложений вы можете почитать в нашем блоге.

### Успешное продление подписки

Это событие создается в случае успешного продления подписки. В момент продления с пользователя списываются деньги.

> В сторонние системы аналитики это событие отсылается под названием *subscription_renewed*.

> Если после продления пользователь остается в рамках вводного предложения, то событие отсылается с флагом `in_intro = TRUE`.

### Неудачное продление подписки

Это событие создается *по окончании* подписки, если ее не удалось продлить.

> В сторонние системы аналитики это событие отсылается под названием *subscription_expired*.

> Если после предполагаемого продления пользователь должен был остаться в рамках вводного предложения, то событие отсылается с флагом `in_intro = TRUE`.

> Продление может не произойти по тем же причинам, что и в случае с триалом.

### Возврат денег

Это событие создается, если Apple вернули деньги пользователю за подписку. Отмена происходит через службу поддержки Apple.

> В сторонние системы аналитики это событие отсылается под названием *subscription_refunded*.

Отмена может произойти по этим причинам:

* у вашего приложения имеется какая-то проблема – *app_issue*;
* другая причина, например, пользователь совершил покупку случайно – *another_reason*.

## Настройки авто-возобновления

Пользователь при наличии активной подписки может в любой момент ее отключить через приложения "Настройки" или "App Store". Или вновь активировать, если она была отключена. В зависимости от этого создаются события "Отключение возобления" и "Включение возобновления".

### Отключение авто-возобновления

Это событие создается, если отключается автоматическое продление подписки. Это может произойти, например, если пользователь отключит ее через приложения "Настройки" или "App Store".

> В сторонние системы аналитики это событие отсылается под названием *autorenew_off*.

### Включение авто-возобновления

Это событие создается, если включается автоматическое продление подписки.

> В сторонние системы аналитики это событие отсылается под названием *autorenew_on*.

## В какие моменты создаются события?

Apphud регулярно просматривает чеки, чтобы создать новые события, если это необходимо. Есть несколько случаев, когда это происходит.

### Когда подписка близка к моменту своего истечения

Apphud отправляет запрос в Apple, чтобы обновить состояние подписки всякий раз, когда подписка должна была продлиться. Чек обновляется в течение часа после предполагаемого времени продления. 

Если подписка успешна продлена, значит с пользователя списаны деньги. В этот момент создается необходимое событие продления: *trial_converted* или *subscription_renewed*. Если на этот момент в системе считалось, что продление отключено, то также создается событие *autorenew_on*.

Если подписка не продлена, то создается событие *trial_expired*, *subscription_expired* или *subscription_refunded*. Если на этот момент в системе считалось, что продление включено, то также создается событие *autorenew_off*.

Apphud продолжает проверять все отмененные или возвращенные подписки. Проверка чеков происходит *каждые 3 часа* без ограничений на число проверок.

### Apple Subscriptions Notifications

Второй метод проверки опционален и использует механизм отправки уведомлений от Apple - Apple Subscriptions Notifications.

Чтобы настроить Subscriptions Notifications воспользуйтесь этим руководством. Мы **настоятельно рекомендуем** их настроить, чтобы получасть более точные данные о статусах подписок.

В определенные моменты времени Apple посылает уведомления на сервер Apphud. Получив любое из уведомлений, сервер проверяет чек и, если нужно, создает новые события.

> Более подробно об Apple Subscriptions Notifications вы можете прочесть в нашем блоге.

