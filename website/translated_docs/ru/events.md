В этом разделе описаны события, которые регистрируются в Apphud и могут отсылаться в сторонние системы аналитики и мессенджеры.

В определенные моменты времени Apphud запрашивает с серверов Apple информацию о текущем состоянии авто-возобновляемой подписки каждого подписчика. Если нужно, регистрирует соответствующее событие и отсылает его во внешнюю аналитику или мессенджер.

## Триальный период

Триальный период – триал – это бесплатный пробный период. Каждый пользователь с уникальным Apple ID может воспользоваться им только один раз в рамках одной группы подписок.

### Оформление триала

Это событие создается, когда пользователь впервые начинает триальный период подписки.

В сторонние системы аналитики это событие отсылается под названием `trial_started`.

### Успешная конвертация триала в обычную подписку

Это событие создается по окончании триала, если пользователь оплачивает первый цикл обычной подписки.

В сторонние системы аналитики это событие отсылается под названием `trial_converted`.

### Неудачная конвертация триала в обычную подписку

Это событие создается *по окончании* триала, если ее не удалось продлить.

В сторонние системы аналитики это событие отсылается под названием `trial_expired`.

Продление может не произойти по этим причинам:

* пользователь самостоятельно отменил подписку – `user_canceled`;
* произошла ошибка при списании денег пользователя при попытке продления подписки – `billing_issue`;
* пользователь не согласился с повышением цены на подписку – `declined_price_increase`;
* продукт (подписка) был недоступен при попытке продления – `unavailable_product`;
* произошла неизвестная ошибка при попытке продления подписки – `unknown_error`.

## Вводное предложение (Introductory offer)

Вводное предложение (Introductory offer) – это скидка, которая действует только для новых подписчиков. Каждый пользователь с уникальным Apple ID может воспользоваться вводным предложением только один раз в рамках одной группы подписок.

> Более подробно о разновидностях вводных предложений вы можете почитать в <a href="https://blog.apphud.com/ru/introductory-offers/" target="_blank">нашем блоге</a>.

### Оформление вводного предложения

Это событие создается, когда пользователь впервые оформляет вводное предложение.

В сторонние системы аналитики это событие отсылается под названием `intro_started`.

### Успешное продление вводного предложения

Это событие создается при продлении подписки, находящейся в рамках вводного предложения. Оно создается, *только* если в результате продления пользователь продолжил пользоваться вводным предложением.

> Это событие может быть создано *только* для вводного предложения типа "Оплата по факту использования" (Pay as you go).

В сторонние системы аналитики это событие отсылается под названием `intro_renewed`.

### Успешная конвертация вводного предложения в обычную подписку

Это событие создается по окончании вводного предложения, если пользователь оплачивает первый цикл обычной подписки.

В сторонние системы аналитики это событие отсылается под названием `intro_converted`.

### Неудачная конвертация вводного предложения в обычную подписку либо неудачное продление 

Это событие создается, если подписка, находившаяся во вводном предложении, истекла без списаний по обычной цене.

В сторонние системы аналитики это событие отсылается под названием `intro_expired`.

> Продление может не произойти по тем же причинам, что и в случае с триалом.

### Возврат денег в пределах вводного предложения

Это событие создается, если пользователь вернул деньги за подписку. И *только* если пользователь в это время пользовался вводным предложением. Отмена происходит через службу поддержки Apple Care.

В сторонние системы аналитики это событие отсылается под названием `intro_refunded`.

Отмена может произойти по этим причинам:

- у вашего приложения имеется какая-то проблема – `app_issue`;
- другая причина, например, пользователь совершил покупку случайно – `another_reason`.

## Обычная подписка

Рассмотрим события, которые создаются в рамках обычной подписки. То есть если пользователь не находится в триале или в вводном предложении.

### Успешное оформление подписки

Это событие создается, когда пользователь оформляет обычную подписку. В этот момент с него списываются деньги.

В сторонние системы аналитики это событие отсылается под названием `subscription_started`.

### Успешное продление подписки

Это событие создается в случае успешного продления подписки. В момент продления с пользователя списываются деньги.

В сторонние системы аналитики это событие отсылается под названием `subscription_renewed`.

### Неудачное продление подписки

Это событие создается *по окончании* цикла подписки, если ее не удалось продлить.

В сторонние системы аналитики это событие отсылается под названием `subscription_expired`.

> Продление может не произойти по тем же причинам, что и в случае с триалом.

### Возврат денег

Это событие создается, если пользователь вернул деньги за подписку. Отмена происходит через службу поддержки Apple Care.

В сторонние системы аналитики это событие отсылается под названием `subscription_refunded`.

> Отмена может произойти по тем же причинам, что и в случае с вводным предложением.

## Настройки авто-возобновления

Пользователь при наличии активной подписки может в любой момент ее отключить через приложения "Настройки" или "App Store". Или вновь активировать, если она была отключена. В зависимости от этого создаются события "Отключение возобления" и "Включение возобновления".

> Настройте Subscription Status URL, чтобы своевременно получать эти события. Более подробно о настройке можно почитать [здесь](creating-app.md#subscription-status-url).

### Отключение авто-возобновления

Это событие создается, если отключается автоматическое продление подписки. Это может произойти, например, если пользователь отключит ее через приложения "Настройки" или "App Store".

В сторонние системы аналитики это событие отсылается под названием `autorenew_disabled`.

### Включение авто-возобновления

Это событие создается, если включается автоматическое продление подписки.

В сторонние системы аналитики это событие отсылается под названием `autorenew_enabled`.

## Промо-предложения

Промо-предложения – это скидки или дополнительный бесплатный пробный период для текущих или бывших подписчиков. Они доступны начиная с iOS 12.2. В отличие от вводных предложений, промо-предложения могут применяться неограниченное количество раз.

### Оформление промо-предложения

Это событие создается, когда пользователь успешно активирует промо-предложение.

В сторонние системы аналитики это событие отсылается под названием `promo_started`.

### Успешное продление промо-предложения

Это событие создается при продлении подписки, находящейся в рамках промо-предложения. Оно создается, *только* если в результате продления пользователь продолжил пользоваться промо-предложением.

> Это событие может быть создано *только* для промо-предложения типа "Оплата по факту использования" (Pay as you go).

В сторонние системы аналитики это событие отсылается под названием `promo_renewed`.

### Успешная конвертация промо-предложения в обычную подписку

Это событие создается по окончании промо-предложения, если пользователь оплачивает обычную подписку.

В сторонние системы аналитики это событие отсылается под названием `promo_converted`.

### Неудачная конвертация промо-предложения в обычную подписку либо неудачное продление 

Это событие создается, если подписка, находившаяся в промо-предложении, истекла без списаний по обычной цене.

В сторонние системы аналитики это событие отсылается под названием `promo_expired`.

> Продление может не произойти по тем же причинам, что и в случае с триалом.

### Возврат денег в пределах промо-предложения

Это событие создается, если пользователь вернул деньги за подписку. И *только* если пользователь в это время пользовался промо-предложением. Отмена происходит через службу поддержки Apple Care.

В сторонние системы аналитики это событие отсылается под названием `promo_refunded`.

Отмена может произойти по этим причинам:

- у вашего приложения имеется какая-то проблема – `app_issue`;
- другая причина, например, пользователь совершил покупку случайно – `another_reason`.

## Когда создаются события?

Apphud регулярно отправляет запросы в App Store, чтобы обновить состояние подписок, и создает новые события, если это необходимо. А используя *Subscription Notifications* Apphud будет регистрировать события практически в реальном времени.

#### Subscription Notifications (или Status Update Notifications или Apple Server-to-Server Notifications)

Чтобы настроить Subscription Notifications воспользуйтесь [этим руководством](creating-app.md#subscription-status-url). Мы **настоятельно рекомендуем** их настроить, чтобы получать более точные данные о состоянии подписок.

В определенные моменты времени Apple отсылает уведомления на сервер Apphud. Получив любое из уведомлений, сервер проверяет чек и, если нужно, создает новые события.

> Более подробно о Server Notifications вы можете прочитать в <a href="https://blog.apphud.com/ru/subscriptions-notifications-2/" target="_blank">нашем блоге</a>.
